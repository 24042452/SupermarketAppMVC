<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/theme.css">
  <title>Checkout</title>

  <style>
    body {
      background: #faf7f2;
      font-family: 'Segoe UI', sans-serif;
      color: #111827;
    }

    .section-title {
      font-size: 1.8rem;
      font-weight: 700;
      margin-bottom: 24px;
    }

    .checkout-box, .summary-box {
      background: #fff;
      border-radius: 16px;
      padding: 22px;
      margin-bottom: 20px;
      border: 1px solid #ececec;
      box-shadow: 0 10px 24px rgba(17, 24, 39, 0.06);
    }

    .section-header {
      font-weight: 700;
      font-size: 1.05rem;
      margin-bottom: 16px;
    }

    .form-label {
      font-weight: 600;
      color: #111827;
      margin-bottom: 6px;
    }

    .form-control {
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      padding: 10px 12px;
    }

    .payment-stack {
      display: grid;
      gap: 14px;
    }

    .pay-option {
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      padding: 14px;
      background: #fff;
      transition: 0.2s ease;
      display: grid;
      gap: 10px;
    }

    .pay-option.active {
      border-color: #22c55e;
      box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.12);
    }

    .pay-option-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .pay-radio {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 700;
      color: #111827;
    }

    .pay-radio input[type="radio"] {
      accent-color: #22c55e;
    }

    .pay-logos {
      display: inline-flex;
      gap: 8px;
      align-items: center;
    }

    .logo-pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      background: #f3f4f6;
      font-size: 0.85rem;
      color: #374151;
      font-weight: 600;
    }

    .logo-pill svg {
      width: 20px;
      height: 20px;
    }

    .paypal-btn {
      width: 100%;
      border: none;
      background: #1f6fcb;
      color: #fff;
      border-radius: 12px;
      padding: 12px 16px;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .paypal-button-container {
      display: none;
    }

    .pay-option.active .paypal-button-container {
      display: block;
    }

    .stripe-button-container {
      display: none;
    }

    .pay-option.active .stripe-button-container {
      display: block;
    }

    .nets-button-container {
      display: none;
    }

    .pay-option.active .nets-button-container {
      display: block;
    }

    .nets-modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.55);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 1050;
    }

    .nets-modal.show {
      display: flex;
    }

    .nets-modal-card {
      background: #fff;
      border-radius: 16px;
      padding: 20px;
      width: min(420px, 92vw);
      border: 1px solid #ececec;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.25);
      text-align: center;
    }

    .nets-modal-card img {
      width: 240px;
      height: 240px;
      object-fit: contain;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      background: #fff;
    }

    .nets-modal-actions {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin-top: 12px;
    }

    .divider {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: 12px;
      color: #94a3b8;
      font-weight: 600;
      font-size: 0.8rem;
    }

    .divider::before,
    .divider::after {
      content: "";
      height: 1px;
      background: #e5e7eb;
    }

    .card-fields {
      display: none;
      gap: 12px;
    }

    .card-fields.show {
      display: grid;
    }

    .cart-item {
      display: flex;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .cart-item img {
      width: 46px;
      height: 46px;
      object-fit: cover;
      border-radius: 10px;
      border: 1px solid #eee;
    }

    .product-title {
      font-size: 0.98rem;
      font-weight: 600;
    }

    .price {
      color: #111827;
      font-weight: 600;
    }

    .summary-box h5 {
      font-size: 1.1rem;
      font-weight: 700;
      margin-bottom: 16px;
    }

    .summary-line {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      color: #374151;
    }

    .summary-total {
      font-weight: 700;
      font-size: 1.1rem;
      color: #111827;
    }

    .btn-place {
      border-radius: 999px;
      font-weight: 700;
      background: #22c55e;
      color: #fff;
      border: none;
      padding: 12px 18px;
    }

    .btn-place:hover {
      background: #16a34a;
      color: #fff;
    }

    .nets-btn {
      width: 100%;
      border: none;
      background: #111827;
      color: #fff;
      border-radius: 12px;
      padding: 12px 16px;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .secure-note {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      color: #6b7280;
      font-size: 0.9rem;
    }

    .secure-note svg {
      width: 16px;
      height: 16px;
    }
  </style>
</head>

<body>
  <%- include('partials/navbar', { user: user, cart: cart }) %>

  <div class="container my-5">
    <h2 class="section-title">Checkout</h2>

    <form action="/checkout" method="POST">
      <div class="row g-4">
        <div class="col-lg-7">
          <% const nameParts = (user.username || '').split(' '); %>
          <% const firstName = nameParts[0] || ''; %>
          <% const lastName = nameParts.slice(1).join(' '); %>

          <div class="checkout-box">
            <div class="section-header">Shipping Information</div>
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">First Name</label>
                <input type="text" class="form-control" value="<%= firstName %>">
              </div>
              <div class="col-md-6">
                <label class="form-label">Last Name</label>
                <input type="text" class="form-control" value="<%= lastName %>">
              </div>
              <div class="col-12">
                <label class="form-label">Email</label>
                <input type="email" class="form-control" value="<%= user.email %>">
              </div>
              <div class="col-12">
                <label class="form-label">Address</label>
                <input type="text" class="form-control" value="<%= user.address %>">
              </div>
              <div class="col-md-6">
                <label class="form-label">City</label>
                <input type="text" class="form-control" placeholder="City">
              </div>
              <div class="col-md-6">
                <label class="form-label">ZIP Code</label>
                <input type="text" class="form-control" placeholder="Postal Code">
              </div>
            </div>
          </div>

          <div class="checkout-box">
            <div class="section-header">Payment Method</div>

            <div class="payment-stack">
              <div class="pay-option" data-payment="PayPal">
                <div class="pay-option-head">
                  <div class="pay-radio">
                    <input type="radio" name="paymentMethod" value="PayPal" required>
                    PayPal Express Checkout
                  </div>
                  <div class="pay-logos">
                    <span class="logo-pill">
                      <svg viewBox="0 0 24 24" aria-hidden="true">
                        <path fill="#1f6fcb" d="M9.7 4.2h5.5c3 0 5 1.6 5 4.4 0 3.3-2.5 5.4-6.3 5.4H12l-.6 4H7.3L9.7 4.2z"/>
                        <path fill="#0a4b8c" d="M6.7 19.8l2.6-15h4.4c2.6 0 4.3 1.3 4.3 3.6 0 3-2.3 4.9-5.7 4.9h-2l-.5 2.9H6.7z"/>
                      </svg>
                      PayPal
                    </span>
                  </div>
                </div>
                <div class="paypal-button-container" id="paypal-button-container"></div>
                <div class="text-muted small text-center">Fast and secure checkout with PayPal</div>
              </div>

              <div class="pay-option" data-payment="Stripe">
                <div class="pay-option-head">
                  <div class="pay-radio">
                    <input type="radio" name="paymentMethod" value="Stripe" required>
                    Stripe Checkout
                  </div>
                  <div class="pay-logos">
                    <span class="logo-pill">Stripe</span>
                  </div>
                </div>
                <div class="stripe-button-container">
                  <button type="button" class="paypal-btn" id="stripeCheckoutBtn">Pay with Stripe</button>
                </div>
                <div class="text-muted small text-center">You will be redirected to Stripe to complete payment</div>
              </div>

              <div class="divider">OR PAY WITH OTHER METHODS</div>

              <div class="pay-option" data-payment="Card">
                <div class="pay-option-head">
                  <div class="pay-radio">
                    <input type="radio" name="paymentMethod" value="Card" required>
                    Credit / Debit Card
                  </div>
                  <div class="pay-logos">
                    <span class="logo-pill">
                      <svg viewBox="0 0 24 24" aria-hidden="true">
                        <rect x="2" y="5" width="20" height="14" rx="3" fill="#111827"/>
                        <rect x="4" y="8" width="16" height="2" fill="#f3f4f6"/>
                      </svg>
                      Card
                    </span>
                  </div>
                </div>
                <div class="card-fields" id="cardFields">
                  <div>
                    <label class="form-label">Card Number</label>
                    <input type="text" class="form-control" placeholder="1234 5678 9012 3456">
                  </div>
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label class="form-label">Expiry Date</label>
                      <input type="text" class="form-control" placeholder="MM/YY">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">CVV</label>
                      <input type="text" class="form-control" placeholder="123">
                    </div>
                  </div>
                </div>
              </div>

              <div class="pay-option" data-payment="PayNow">
                <div class="pay-option-head">
                  <div class="pay-radio">
                    <input type="radio" name="paymentMethod" value="PayNow" required>
                    PayNow
                  </div>
                  <div class="pay-logos">
                    <span class="logo-pill">QR</span>
                  </div>
                </div>
                <div class="text-muted small">Receive a PayNow QR code after placing the order.</div>
              </div>

              <div class="pay-option" data-payment="NETSQR">
                <div class="pay-option-head">
                  <div class="pay-radio">
                    <input type="radio" name="paymentMethod" value="NETSQR" required>
                    NETS QR
                  </div>
                  <div class="pay-logos">
                    <span class="logo-pill">NETS</span>
                  </div>
                </div>
                <div class="nets-button-container">
                  <button type="button" class="nets-btn" id="netsQrBtn">Pay with NETS QR</button>
                </div>
                <div class="text-muted small">Scan the NETS QR code to complete payment.</div>
              </div>
            </div>
          </div>

          <div class="secure-note mt-2">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <rect x="4" y="11" width="16" height="9" rx="2"></rect>
              <path d="M8 11V7a4 4 0 0 1 8 0v4"></path>
            </svg>
            Secure & encrypted payment
          </div>
        </div>

        <div class="col-lg-5">
          <div class="summary-box">
            <h5>Order Summary</h5>

            <% let totalAmount = subtotal || 0 %>
            <% cart.forEach(item => { %>
              <div class="cart-item">
                <img src="/images/<%= item.image %>" alt="<%= item.productName %>">
                <div class="ms-3 w-100">
                  <div class="product-title"><%= item.productName %></div>
                  <div class="text-muted small">Qty: <%= item.quantity %></div>
                </div>
                <div class="price">$<%= (item.price * item.quantity).toFixed(2) %></div>
              </div>
            <% }) %>

            <% const shippingFeeFinal = typeof shippingFee === 'number' ? shippingFee : (totalAmount >= 50 ? 0 : 4.99); %>
            <% const totalWithShipping = typeof total === 'number' ? total : (totalAmount + shippingFeeFinal); %>

            <div class="summary-line">
              <span>Subtotal</span>
              <span>$<%= totalAmount.toFixed(2) %></span>
            </div>
            <div class="summary-line">
              <span>Delivery</span>
              <span>$<%= shippingFeeFinal.toFixed(2) %></span>
            </div>
            <div class="summary-line summary-total">
              <span>Total</span>
              <span>$<%= totalWithShipping.toFixed(2) %></span>
            </div>

            <button class="btn btn-place w-100 mt-3">Place Order</button>
          </div>
        </div>
      </div>
    </form>
  </div>

  <% if (paypalClientId) { %>
    <script src="https://www.paypal.com/sdk/js?client-id=<%= paypalClientId %>&currency=SGD&intent=capture"></script>
  <% } %>

  <script>
    const paymentOptions = document.querySelectorAll('.pay-option');
    const cardFields = document.getElementById('cardFields');
    const checkoutForm = document.querySelector('form[action="/checkout"]');
    const netsQrBtn = document.getElementById('netsQrBtn');
    const stripeCheckoutBtn = document.getElementById('stripeCheckoutBtn');

    const updatePaymentState = () => {
      const selected = document.querySelector('input[name="paymentMethod"]:checked');
      paymentOptions.forEach((option) => {
        const isActive = selected && option.dataset.payment === selected.value;
        option.classList.toggle('active', Boolean(isActive));
      });

      if (cardFields) {
        const showCard = selected && selected.value === 'Card';
        cardFields.classList.toggle('show', Boolean(showCard));
      }
    };

    document.querySelectorAll('input[name="paymentMethod"]').forEach((radio) => {
      radio.addEventListener('change', updatePaymentState);
    });

    paymentOptions.forEach((option) => {
      option.addEventListener('click', (e) => {
        if (e.target && e.target.closest('input[type="radio"]')) return;
        const radio = option.querySelector('input[name="paymentMethod"]');
        if (!radio) return;
        radio.checked = true;
        updatePaymentState();
      });
    });

    updatePaymentState();

    if (netsQrBtn) {
      netsQrBtn.addEventListener('click', () => {
        const netsRadio = document.querySelector('input[name="paymentMethod"][value="NETSQR"]');
        if (netsRadio) netsRadio.checked = true;
        updatePaymentState();
        window.open('/nets-qr/pay', '_blank');
      });
    }

    if (stripeCheckoutBtn) {
      stripeCheckoutBtn.addEventListener('click', async () => {
        const stripeRadio = document.querySelector('input[name="paymentMethod"][value="Stripe"]');
        if (stripeRadio) stripeRadio.checked = true;
        updatePaymentState();
        try {
          const response = await fetch('/stripe/create-session', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin'
          });
          const data = await response.json();
          if (!response.ok || !data.url) {
            alert(data.error || 'Unable to start Stripe Checkout.');
            return;
          }
          const newTab = window.open(data.url, '_blank');
          if (!newTab) {
            window.location.href = data.url;
          }
        } catch (err) {
          console.error('Stripe checkout error:', err);
          alert('Unable to start Stripe Checkout.');
        }
      });
    }


    if (checkoutForm) {
      checkoutForm.addEventListener('submit', (e) => {
        const selected = document.querySelector('input[name="paymentMethod"]:checked');
        if (selected && selected.value === 'NETSQR') {
          e.preventDefault();
          alert('Please complete NETS payment in the new tab before placing the order.');
        }
        if (selected && selected.value === 'Stripe') {
          e.preventDefault();
          alert('Please use the Stripe Checkout button to complete payment.');
        }
      });
    }

    const renderPaypalButtons = () => {
      if (!window.paypal) return;

      window.paypal.Buttons({
        createOrder: () => {
          return fetch('/paypal/create-order', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin'
          })
            .then((res) => res.json())
            .then((data) => data.id);
        },
        onApprove: (data) => {
          return fetch('/paypal/capture-order', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({ orderId: data.orderID })
          })
            .then((res) => res.json())
            .then(() => {
              const paypalRadio = document.querySelector('input[name="paymentMethod"][value="PayPal"]');
              if (paypalRadio) paypalRadio.checked = true;
              if (checkoutForm) checkoutForm.submit();
            });
        },
        onError: (err) => {
          console.error('PayPal error:', err);
          alert('PayPal payment failed. Please try again.');
        }
      }).render('#paypal-button-container');
    };

    if (window.paypal) {
      renderPaypalButtons();
    } else if (document.querySelector('#paypal-button-container')) {
      const waitForPaypal = setInterval(() => {
        if (window.paypal) {
          clearInterval(waitForPaypal);
          renderPaypalButtons();
        }
      }, 150);
    }
  </script>
</body>
</html>
