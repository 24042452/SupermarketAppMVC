<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Invoice #<%= order.id %></title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link rel="stylesheet" href="/css/theme.css">
  <style>
    body {
      background: linear-gradient(135deg, #f7f9fc 0%, #eef2f6 45%, #ffffff 100%);
      font-family: 'Segoe UI', sans-serif;
      color: #0f172a;
    }
    .page {
      max-width: 900px;
      margin: 24px auto;
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 18px;
      padding: 28px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
    }
    .invoice-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
      border-bottom: 1px solid #e2e8f0;
      padding-bottom: 16px;
      margin-bottom: 18px;
    }
    .brand {
      font-size: 1.5rem;
      font-weight: 800;
      letter-spacing: -0.02em;
      color: #0b1c40;
    }
    .muted { color: #6b7280; }
    .badge-status {
      padding: 8px 14px;
      border-radius: 999px;
      font-weight: 700;
      text-transform: capitalize;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .status-pending { background: #fff4e5; color: #b45309; }
    .status-delivery { background: #e0edff; color: #1d4ed8; }
    .status-delivered { background: #dcfce7; color: #15803d; }
    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 14px;
      margin-bottom: 12px;
    }
    .info-card {
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 12px 14px;
      background: #f9fbff;
    }
    .table > :not(caption) > * > * {
      padding: 12px 10px;
      vertical-align: middle;
    }
    .totals {
      border-top: 1px solid #e2e8f0;
      padding-top: 10px;
    }
    .print-btn { gap: 6px; }
    .btn-ghost {
      background: #f1f5f9;
      color: #0f172a;
      border: 1px solid #e2e8f0;
      transition: all 0.18s ease;
    }
    .btn-ghost:hover { background: #e2e8f0; color: #0f172a; }
    .btn-cta {
      background: linear-gradient(135deg, #2563eb, #60a5fa);
      color: #fff;
      border: none;
      box-shadow: 0 8px 18px rgba(37, 99, 235, 0.22);
      transition: all 0.2s ease;
    }
    .btn-cta:hover { transform: translateY(-1px); color: #fff; box-shadow: 0 10px 20px rgba(37, 99, 235, 0.28); }
  </style>
</head>
<body>
  <%- include('partials/navbar', { user: user, cart: cart }) %>

  <div class="page">
    <% const fmtDate = (d) => { try { return new Date(d).toLocaleDateString('en-GB'); } catch(e) { return d; } }; %>
    <% const statusLower = (order.status || '').toLowerCase(); %>
    <% let statusClass = 'status-pending'; %>
    <% if (statusLower === 'delivery') statusClass = 'status-delivery'; %>
    <% if (statusLower === 'delivered') statusClass = 'status-delivered'; %>

    <div class="invoice-header">
      <div>
        <div class="brand">Supermarket Invoice</div>
        <div class="muted">Thank you for your purchase!</div>
      </div>
      <div class="text-end">
        <div class="badge-status <%= statusClass %>">
          <i class="bi bi-receipt"></i>
          <span><%= statusLower || 'pending' %></span>
        </div>
        <div class="mt-2 small text-muted">Order #<%= order.id %></div>
        <div class="small text-muted">Date: <%= fmtDate(order.order_date) %></div>
      </div>
    </div>

    <div class="info-grid">
      <div class="info-card">
        <div class="fw-bold mb-1">Billed To</div>
        <div><%= user && user.username ? user.username : 'Customer' %></div>
        <div class="muted"><%= user && user.email ? user.email : '' %></div>
        <div class="muted"><%= user && user.address ? user.address : 'No address provided' %></div>
        <div class="muted"><%= user && user.contact ? user.contact : '' %></div>
      </div>
      <div class="info-card">
        <div class="fw-bold mb-1">Summary</div>
        <div class="muted">Payment: On checkout</div>
        <div class="muted">Status: <%= statusLower || 'pending' %></div>
        <div class="muted">Items: <%= order.items.length %></div>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-borderless align-middle">
        <thead class="table-light">
          <tr>
            <th scope="col">Item</th>
            <th scope="col" class="text-center">Qty</th>
            <th scope="col" class="text-end">Price</th>
            <th scope="col" class="text-end">Total</th>
          </tr>
        </thead>
        <tbody>
          <% order.items.forEach((item) => { 
               const lineTotal = Number(item.quantity) * Number(item.price);
          %>
            <tr>
              <td>
                <div class="d-flex align-items-center gap-3">
                  <img src="/images/<%= item.image %>" alt="<%= item.productName %>" width="54" height="54" style="object-fit: contain; border:1px solid #e2e8f0; border-radius:10px; padding:6px; background:#f8fbff;">
                  <div>
                    <div class="fw-semibold"><%= item.productName %></div>
                    <div class="small text-muted">#<%= item.productId %></div>
                  </div>
                </div>
              </td>
              <td class="text-center"><%= item.quantity %></td>
              <td class="text-end">$<%= Number(item.price).toFixed(2) %></td>
              <td class="text-end">$<%= lineTotal.toFixed(2) %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>

    <div class="d-flex justify-content-end">
      <div style="min-width: 260px;">
        <div class="d-flex justify-content-between muted">
          <span>Subtotal</span>
          <span>$<%= Number(order.subtotal || 0).toFixed(2) %></span>
        </div>
        <div class="d-flex justify-content-between muted">
          <span>Delivery</span>
          <span>$<%= Number(order.shippingFee || 0).toFixed(2) %></span>
        </div>
        <div class="d-flex justify-content-between fw-bold fs-5 totals">
          <span>Grand Total</span>
          <span>$<%= Number(order.grandTotal || order.total || 0).toFixed(2) %></span>
        </div>
      </div>
    </div>

    <div class="mt-4">
      <h6 class="fw-bold mb-2">Refund</h6>
      <% if (refundRequest) { %>
        <div class="text-muted small">Status: <%= refundRequest.status %> &nbsp;|&nbsp; Requested: $<%= Number(refundRequest.amount || 0).toFixed(2) %></div>
        <% if ((refundRequest.status || '').toLowerCase() === 'approved') { %>
          <div class="text-muted small mt-1">Refund type: <%= (order.refund_status === 'refunded') ? 'Full' : (order.refund_status === 'partial' ? 'Partial' : 'â€”') %></div>
        <% } %>
        <% if (refundRequest.admin_note) { %>
          <div class="text-muted small mt-1">Admin note: <%= refundRequest.admin_note %></div>
        <% } %>
      <% } else if (user && user.role !== 'admin' && user.role !== 'superadmin') { %>
        <form action="/orders/<%= order.id %>/refund" method="POST" class="d-flex flex-wrap gap-2 align-items-center">
          <button type="submit" class="btn btn-ghost">Request Refund</button>
        </form>
        <div class="text-muted small mt-1">Refunds are reviewed by admin (full or partial).</div>
      <% } %>
    </div>

    <% const backUrl = user && user.role === 'admin' ? '/admin/orders' : '/orders'; %>
    <div class="d-flex justify-content-between align-items-center mt-4">
      <a href="<%= backUrl %>" class="btn btn-ghost d-inline-flex align-items-center gap-2">
        <i class="bi bi-arrow-left"></i> Back to Orders
      </a>
      <button class="btn btn-cta d-inline-flex align-items-center print-btn" onclick="window.print()">
        <i class="bi bi-printer"></i> Print Invoice
      </button>
    </div>
  </div>
</body>
</html>
